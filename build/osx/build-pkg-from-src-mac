#!/usr/bin/ksh

# Create package from local source
# Kevin Davies
# Version 1.0

# echo get package version
VER=`git describe --tags | head -1`
VER=${VER#v}
VER=${VER%-*-*}

# setup system vars
DIR=${PWD}
APP=alpaca
ID=com.app.${APP}
PKG=${APP}-${VER}.pkg
GOPATH=${DIR}/go
BUILD=${GOPATH}
SCRIPTS=${GOPATH}/scripts
export GOPATH

# Build and install to temp directory
umask 000
mkdir -p ${BUILD}/bin
ln -s ../../.. ${BUILD}/src
cd ${BUILD}/src
go install -ldflags="-X 'main.Version=${VER}' -X 'main.User=$(id -u -n)' -X 'main.Time=$(date)'" 

# Copy postinstall script into place
cd ${DIR}
mkdir -p ${SCRIPTS}
cp postinstall ${SCRIPTS}

# Build MacOSX package
pkgbuild --scripts ${SCRIPTS} --identifier ${ID} --version ${VER} --root ${BUILD}  ${PKG}

# Cleanup
chmod -R u+rwX ${BUILD}
rm -rf ${SCRIPTS} ${BUILD}

exit
